# 等级系统部署指南

## 概述

本指南说明如何在Railway上部署和启用等级系统功能。等级系统是一个独立的模块，可以随时启用或禁用，不会影响现有系统功能。

## 系统架构

### 核心特性
- **完全独立**：使用独立的 `level_system.db` 数据库文件
- **零破坏性**：不修改现有数据库结构
- **可逆集成**：可随时禁用或卸载
- **Railway兼容**：支持Volume挂载和环境变量配置

### 功能模块
1. **等级系统**：用户等级、经验值、升级机制
2. **积分系统**：积分获取、消耗、历史记录
3. **勋章系统**：成就勋章、解锁条件、稀有度
4. **管理界面**：用户管理、勋章管理、数据统计

## 部署步骤

### 1. 环境变量配置

在Railway项目的Variables中添加：

```bash
LEVEL_SYSTEM_ENABLED=true
```

### 2. 数据库初始化

系统会在首次启动时自动初始化：
- 创建 `level_system_dev.db`（开发环境）或 `level_system.db`（生产环境）
- 创建所有必需的数据表
- 插入默认配置和勋章

### 3. Volume配置

等级系统数据库文件会自动存储在已配置的Volume中：
- 路径：`/app/data/level_system.db`
- 与现有数据库文件（`xiaoji.db`）并存

### 4. 验证部署

部署后验证步骤：

1. **检查日志**
   ```
   🏆 初始化等级系统...
   ✅ 等级系统初始化完成
   ```

2. **测试Bot命令**
   - `/level` - 查看等级信息
   - `/badges` - 查看勋章
   - `/points` - 查看积分历史
   - `/ranking` - 查看排行榜

3. **访问管理界面**
   - URL: `https://your-app.railway.app/admin/level-system`
   - 功能：用户管理、勋章管理、数据统计

## 功能配置

### 等级配置

默认等级设置：
- Lv.1 新手小鸡（0经验，0评价）
- Lv.2 熟练小鸡（100经验，5评价）
- Lv.3 精英小鸡（500经验，20评价）
- Lv.4 大师小鸡（1500经验，50评价）
- Lv.5 传说小鸡（3000经验，100评价）

### 奖励配置

| 行为 | 经验奖励 | 积分奖励 | 说明 |
|------|----------|----------|------|
| 评价商家 | 20 | 10 | 完成商家评价 |
| 评价用户 | 15 | 5 | 完成用户评价 |
| 被评价 | 10 | 5 | 被其他用户评价 |
| 升级奖励 | 0 | 50 | 等级提升时获得 |

### 勋章系统

默认勋章类型：
- **普通勋章**：基础成就
- **稀有勋章**：需要一定努力
- **史诗勋章**：较难获得
- **传说勋章**：非常困难
- **神话勋章**：极其稀有

## 集成点

### 1. 评价系统集成

在 `evaluationService.js` 中已集成：
```javascript
// 评价完成后自动触发等级奖励
if (process.env.LEVEL_SYSTEM_ENABLED === 'true') {
    this.triggerLevelSystemHook(evaluationId);
}
```

### 2. Bot命令集成

在 `botService.js` 中已添加命令处理：
- 等级查询命令
- 勋章查看命令
- 积分历史命令
- 排行榜命令

### 3. API接口

新增API端点：
- `GET /api/level/users` - 用户列表
- `GET /api/level/users/{id}` - 用户详情
- `PUT /api/level/users/{id}` - 更新用户
- `GET /api/level/badges` - 勋章列表
- `POST /api/level/badges` - 创建勋章
- `GET /api/level/stats` - 统计数据

## 维护指南

### 数据备份

等级系统数据独立存储，备份时需要：
```bash
# 备份等级系统数据库
cp /app/data/level_system.db /app/data/level_system_backup_$(date +%Y%m%d).db
```

### 性能优化

1. **缓存机制**：用户档案缓存5分钟
2. **批量操作**：使用事务处理批量更新
3. **索引优化**：已为常用查询字段建立索引

### 故障排除

1. **等级系统未启用**
   - 检查环境变量 `LEVEL_SYSTEM_ENABLED`
   - 查看启动日志

2. **数据库初始化失败**
   - 检查Volume权限
   - 查看错误日志

3. **命令无响应**
   - 确认Bot有发送消息权限
   - 检查群组ID配置

## 禁用等级系统

如需禁用等级系统：

1. 在Railway Variables中设置：
   ```bash
   LEVEL_SYSTEM_ENABLED=false
   ```

2. 重新部署应用

3. 数据将保留，可随时重新启用

## 安全注意事项

1. **权限控制**：管理界面需要额外的访问控制
2. **数据隔离**：等级系统数据与业务数据完全隔离
3. **备份策略**：定期备份等级系统数据库

## 更新日志

### v1.0.0 (2024-01-07)
- 初始版本发布
- 实现基础等级系统
- 集成评价系统
- 添加管理界面

## 联系支持

如有问题，请联系技术支持团队。 